import{I as Q,b as N,c as q,d as H,T as O}from"./TiledImageSource-BrtEEhz2.js";import{l as _,i as s,bc as tt,d as et,V as ot}from"./three.module-Cdr6prlM.js";const F=new _,X=new _;function it(u,t,e){const i=e+1e-5;let n=t+1e-5;Math.abs(n)>Math.PI/2&&(n=n-1e-5),u.getCartographicToPosition(t,e,0,F),u.getCartographicToPosition(n,e,0,X);const r=F.distanceTo(X)/1e-5;return u.getCartographicToPosition(t,i,0,X),[F.distanceTo(X)/1e-5,r]}const nt=30,rt=15,Y=new _,R=new _,d=new ot,U=new et;class Z extends Q{get projection(){return this.tiling.projection}constructor(t={}){const{shape:e="planar",endCaps:o=!0,...i}=t;super(i),this.shape=e,this.endCaps=o}async parseToMesh(t,e,...o){const i=await super.parseToMesh(t,e,...o),{shape:n,projection:r,tiles:c,tiling:h}=this;if(n==="ellipsoid"){const g=c.ellipsoid,M=e[N],v=e[q],E=e[H],[f,I,A,D]=h.getTileBounds(v,E,M,!0),[P,p,x,a]=e.boundingVolume.region,S=Math.ceil((a-p)*s.RAD2DEG*.25),G=Math.ceil((x-P)*s.RAD2DEG*.25),b=Math.max(rt,S),w=Math.max(nt,G),B=new tt(1,1,w,b),{position:L,normal:V,uv:y}=B.attributes,C=L.count;e.cached.boundingVolume.getSphere(U);for(let l=0;l<C;l++){Y.fromBufferAttribute(L,l),R.fromBufferAttribute(V,l),d.fromBufferAttribute(y,l);const j=s.mapLinear(d.x,0,1,P,x);let m=s.mapLinear(d.y,0,1,p,a);if(r.isMercator&&d.y!==0&&d.y!==1){const T=r.convertProjectionToLatitude(1),W=1/b,J=s.mapLinear(d.y-W,0,1,p,a),K=s.mapLinear(d.y+W,0,1,p,a);m>T&&J<T&&(m=T),m<-T&&K>-T&&(m=-T)}g.getCartographicToPosition(m,j,0,Y).sub(U.center),g.getCartographicToNormal(m,j,R);const z=s.mapLinear(r.convertLongitudeToProjection(j),f,A,0,1),k=s.mapLinear(r.convertLatitudeToProjection(m),I,D,0,1);y.setXY(l,z,k),L.setXYZ(l,...Y),V.setXYZ(l,...R)}i.geometry=B,i.position.copy(U.center)}return i}createBoundingVolume(t,e,o){if(this.shape==="ellipsoid"){const{tiling:i,endCaps:n}=this,r=o===-1,c=r?i.getFullBounds(!0):i.getTileBounds(t,e,o,!0),h=r?i.getFullBounds():i.getTileBounds(t,e,o);return n&&(c[3]===1&&(h[3]=Math.PI/2),c[1]===0&&(h[1]=-Math.PI/2)),{region:[...h,-1,1]}}else return super.createBoundingVolume(t,e,o)}preprocessNode(t,...e){super.preprocessNode(t,e);const{shape:o,projection:i,tiling:n}=this;if(o==="ellipsoid"){const r=t[N],c=t[q],h=t[H];if(r===-1)return t.geometricError=1e50,parent;const[g,M,v,E]=n.getTileBounds(c,h,r,!0),{tilePixelWidth:f,tilePixelHeight:I}=n.getLevel(r),{pixelWidth:A,pixelHeight:D}=n.getLevel(n.maxLevel),P=(v-g)/f,p=(E-M)/I,x=1/A,a=1/D,[,S,G,b]=n.getTileBounds(c,h,r),w=S>0!=b>0?0:Math.min(Math.abs(S),Math.abs(b)),B=i.convertLatitudeToProjection(w),L=i.getLongitudeDerivativeAtValue(g),V=i.getLatitudeDerivativeAtValue(B),[y,C]=it(this.tiles.ellipsoid,w,G),l=Math.max(P*L*y,p*V*C),j=Math.max(x*L*y,a*V*C);t.geometricError=l-j,t.parent===null&&(t.geometricError=1e50)}return t}}class ${get isMercator(){return this.scheme==="EPSG:3857"}constructor(t="EPSG:4326"){this.scheme=t,this.tileCountX=1,this.tileCountY=1,this.setScheme(t)}setScheme(t){switch(this.scheme=t,t){case"EPSG:4326":this.tileCountX=2,this.tileCountY=1;break;case"EPSG:3857":this.tileCountX=1,this.tileCountY=1;break;default:throw new Error}}convertProjectionToLatitude(t){if(this.isMercator){const e=s.mapLinear(t,0,1,-1,1);return 2*Math.atan(Math.exp(e*Math.PI))-Math.PI/2}else return s.mapLinear(t,0,1,-Math.PI/2,Math.PI/2)}convertProjectionToLongitude(t){return s.mapLinear(t,0,1,-Math.PI,Math.PI)}convertLatitudeToProjection(t){if(this.isMercator){const e=Math.log(Math.tan(Math.PI/4+t/2));return 1/2+1*e/(2*Math.PI)}else return s.mapLinear(t,-Math.PI/2,Math.PI/2,0,1)}convertLongitudeToProjection(t){return(t+Math.PI)/(2*Math.PI)}getLongitudeDerivativeAtValue(t){return 2*Math.PI}getLatitudeDerivativeAtValue(t){let o=t-1e-5;return o<0&&(o=t+1e-5),this.isMercator?Math.abs(this.convertProjectionToLatitude(t)-this.convertProjectionToLatitude(o))/1e-5:Math.PI}getBounds(){return[this.convertProjectionToLongitude(0),this.convertProjectionToLatitude(0),this.convertProjectionToLongitude(1),this.convertProjectionToLatitude(1)]}}class st extends O{constructor(t={}){super();const{levels:e=20,tileDimension:o=256}=t;this.tileDimension=o,this.levels=e,this.url=null}getUrl(t,e,o){return this.url.replace("{z}",o).replace("{x}",t).replace("{y}",e)}init(t){const{tiling:e,tileDimension:o,levels:i}=this;e.flipY=!0,e.setProjection(new $("EPSG:3857")),e.generateLevels(i,1,1,{tilePixelWidth:o,tilePixelHeight:o}),this.url=t}}class at extends O{constructor(){super(),this.tileSets=null,this.extension=null,this.url=null}getUrl(t,e,o){const{url:i,extension:n,tileSets:r,tiling:c}=this;return new URL(`${parseInt(r[o-c.minLevel].href)}/${t}/${e}.${n}`,i).toString()}init(t){return this.fetchData(t,this.fetchOptions).then(e=>e.text()).then(e=>{const{tiling:o}=this,i=new DOMParser().parseFromString(e,"text/xml"),n=i.querySelector("BoundingBox"),r=i.querySelector("Origin"),c=i.querySelector("TileFormat"),g=[...i.querySelector("TileSets").querySelectorAll("TileSet")].map(a=>({href:parseInt(a.getAttribute("href")),unitsPerPixel:parseFloat(a.getAttribute("units-per-pixel")),order:parseInt(a.getAttribute("order"))})).sort((a,S)=>a.order-S.order),M=parseFloat(n.getAttribute("minx"))*s.DEG2RAD,v=parseFloat(n.getAttribute("maxx"))*s.DEG2RAD,E=parseFloat(n.getAttribute("miny"))*s.DEG2RAD,f=parseFloat(n.getAttribute("maxy"))*s.DEG2RAD,I=parseFloat(r.getAttribute("x"))*s.DEG2RAD,A=parseFloat(r.getAttribute("y"))*s.DEG2RAD,D=parseInt(c.getAttribute("width")),P=parseInt(c.getAttribute("height")),p=c.getAttribute("extension"),x=i.querySelector("SRS").textContent;this.extension=p,this.url=t,this.tileSets=g,o.setProjection(new $(x)),o.setOrigin(I,A),o.setBounds(M,E,v,f),g.forEach(({order:a})=>{o.setLevel(a,{tileCountX:o.projection.tileCountX*2**a,tilePixelWidth:D,tilePixelHeight:P})})})}}class ut extends Z{constructor(t={}){const{levels:e=20,tileDimension:o=256,pixelSize:i=1e-5,...n}=t;super({pixelSize:i,...n}),this.name="XYZ_TILES_PLUGIN",this.imageSource=new st({levels:e,tileDimension:o})}}class ht extends Z{constructor(...t){super(...t),this.name="TMS_TILES_PLUGIN",this.imageSource=new at}}export{$ as P,ht as T,ut as X};
